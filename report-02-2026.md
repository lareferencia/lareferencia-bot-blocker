# Bot Blocking Strategy Report â€” February 2026 (Expanded)

## Executive Summary
During February 2026, the blocker moved from a mainly `/24`-centric model to a two-layer model:
- Local blocking for strong `/24` offenders.
- Principal distributed-pressure blocking at `/16` for swarm traffic under high load.

This shift was driven by real traffic behavior: high cardinality bot swarms spread across many `/24` ranges, where each subnet looked "low-intensity" alone but harmful in aggregate.

## Operational Context and Evidence
Key observations from production runs:
- Large-window analysis processed ~1.89M requests across ~268k subnets, with 0 blockable subnets at initial strict settings.
- CPU pressure frequently exceeded practical limits (examples observed above normalized 600% and up to 4000%+ under attack).
- One-hour windows showed tens of thousands of active `/24` candidates with low per-subnet RPM but high distributed spread.
- UFW rule sets grew quickly during peaks, including many `/16` and `/24` entries.

Conclusion:
- Attackers adapted to evade pure `/24` thresholds.
- Aggregate behavior at supernet level was required.
- Cleanup logic also needed hardening to avoid mass unblock events.

## Strategy Evolution

### Phase 1: Visibility First
Implemented:
- `subnet_coverage_report.py`

Purpose:
- Quantify blocked vs. unblocked traffic.
- Identify "near-threshold" pressure.
- Explain misses by condition gap (RPM, sustained, or both).

Impact:
- Exposed that the dominant miss pattern was RPM shortfall at `/24`, despite sustained swarm presence.

### Phase 2: Core Blocking Model Shift
Implemented in `blocker.py`:
- Removed near-miss optional mode from primary flow.
- Added principal `/16` distributed-pressure stage.
- Added thresholds:
  - `--supernet-min-rpm-total`
  - `--supernet-min-ip-count`
  - `--supernet-min-requests`

Decision logic:
- `/16` distributed-pressure checks run in block mode when CPU is in aggressive zone.
- `/24` scoring remains active for concentrated offenders.

Impact:
- Better capture of "many-small-subnets" bot patterns.
- Faster containment of rotating pools from the same broader network.

### Phase 3: Unified Strategy Hardening
Implemented in `strategies/unified.py` and wiring in `blocker.py`:
- Fixed aggressive trigger edge from `>` to `>=` for CPU threshold activation.
- Increased weight for IP diversity.
- Added explicit swarm condition using:
  - `--ip-swarm-threshold`
  - `--ip-swarm-rpm-factor`
  - `--ip-swarm-bonus-max`

Impact:
- Large-IP swarms can be blocked even when strict RPM is slightly below classic threshold.
- Reduces blind spots against distributed low-and-slow behavior.

### Phase 4: Logging Clarity and Compactness
Implemented in `blocker.py`:
- Standardized UTC ISO timestamp logs (`YYYY-MM-DDTHH:MM:SSZ`).
- Added compact one-line block events for `/16` and `/24`.
- Moved verbose reasons to DEBUG, kept INFO concise.
- Consolidated parameter output into a compact line.

Impact:
- Better readability during incidents.
- Easier grep/correlation across logs and timelines.

### Phase 5: Cleanup Safety Heuristic (No New CLI Params)
Implemented in `ufw_handler.py` (`clean_expired_rules`):
- Fixed post-expiry grace period before deletion: `45m`.
- Max deletions per cleanup run: `24`.
- Under high load (`load1/cpu >= 1.5`), cap lowers to `8`.
- Family cap to avoid releasing too many related prefixes in one run:
  - IPv4 grouped by `/16`, max `2` deletions per family per run.
  - IPv6 grouped by `/48`, same cap.
- Oldest expired rules are deleted first.

Impact:
- Prevents "all-at-once" release of previously hot networks.
- Reduces risk of unblock/reblock thrash and sudden re-pressure.

## Current Detection Model (High Level)
1. Parse and aggregate threat metrics by subnet.
2. Compute effective thresholds from current load.
3. Evaluate `/16` distributed pressure (principal anti-swarm layer).
4. Evaluate individual `/24`/single-IP blocks via unified strategy scoring.
5. Apply strike-based duration escalation.
6. Periodically clean expired UFW rules with drip-release heuristic.

## Why This Works Better for the Observed Attack Shape
- Attack traffic is distributed by design; `/24` alone underestimates risk.
- Aggregating by `/16` restores signal from dispersed bot waves.
- IP swarm weighting increases sensitivity to coordinated multi-IP behavior.
- Controlled cleanup prevents immediate re-exposure of recently abusive network families.

## Recommended Runtime Profile (Current Baseline)
Recommended baseline used successfully during February tuning:
- `--time-window hour`
- `--min-rpm-threshold 6`
- `--min-sustained-percent 20`
- `--max-cpu-load-threshold 75`
- `--supernet-min-rpm-total 4.5`
- `--supernet-min-ip-count 80`
- `--supernet-min-requests 150`
- `--block-duration 120`

Operational guidance:
- Use `--dry-run` before major threshold changes.
- Keep whitelist minimal and audited.
- Run `--clean-rules` on a regular schedule (the new heuristic already throttles release).

## Risk Profile and Tradeoffs
Main risks:
- Overblocking broad ranges when `/16` pressure is high.
- Possible collateral impact on legitimate traffic sharing abusive networks.
- Rule table growth under prolonged attack windows.

Mitigations already in place:
- Strike history and escalation windows.
- Threshold tuning based on observed logs, not one-off spikes.
- Compact logs for faster review and rollback decisions.
- Cleanup throttling with grace and per-family limits.

## What Changed in Files
- `blocker.py`
  - Principal `/16` distributed-pressure blocking.
  - Swarm parameters integration.
  - Compact UTC logging output.
- `strategies/unified.py`
  - Aggressive CPU trigger edge fix (`>=`).
  - Stronger IP diversity weighting and swarm-oriented block condition.
- `ufw_handler.py`
  - Cleanup drip-release heuristic with fixed internal limits.
- `subnet_coverage_report.py`
  - Dedicated coverage diagnostics.
- `README.md`
  - Updated strategy and parameter documentation.

## Next Technical Improvements
1. Add a machine-readable post-run summary (JSON) for dashboards.
2. Track per-ASN pressure to complement `/16` decisions.
3. Add temporary "cooldown score" so recently abusive families decay gradually before full release.
4. Add explicit false-positive review report for top blocked ranges.

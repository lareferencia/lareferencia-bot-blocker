# Tuning Snapshot Analysis Context

Use this document as context when analyzing a `tuning-snapshot.md` report generated by `tuning_snapshot.py`.

The goal is to recommend safe and useful parameter changes for `blocker.py` based on one snapshot, without overreacting to temporary noise.

## Objective

Given a `tuning-snapshot.md` report, answer:

- What does the traffic pattern look like?
- Which blocker layer is currently doing most of the work (`IP`, `/24`, `/16`)?
- Which thresholds are the main bottlenecks?
- What is the safest next tuning step?
- What should be validated before changing production thresholds?

Do not optimize only for higher coverage. Prefer balanced recommendations that consider:

- false positives
- rule growth
- subnet collateral impact
- known legitimate crawlers or infrastructure

## Expected Input

The report usually includes these sections:

1. `Executive Summary`
2. `Window Summary`
3. `Traffic Shape`
4. `Current Config Outcome`
5. `Near Miss Analysis`
6. `Sensitivity Sweep`
7. `Recommended Tuning Direction`
8. `Operational Cautions`
9. `Script Parameters`

If a section is missing, state that explicitly and continue with the available evidence.

## Core Interpretation Rules

### 1. Read the traffic shape before proposing any change

Start with:

- total requests
- unique IPs
- unique `/24`
- unique `/16`
- global req/min
- host load

Interpret the shape:

- Very high unique IPs with low per-IP activity usually means distributed swarm pressure.
- High `/24` counts with low requests per `/24` usually means low-and-slow fan-out traffic.
- A few very strong `/24` with high req/min usually means concentrated subnet abuse.
- A few very strong IPs with low subnet spread usually means single-source persistence.

### 2. Treat the three blocking layers differently

The blocker uses three layers:

- `IP`: strict per-IP persistence layer
- `/24`: main subnet precision layer
- `/16`: distributed-pressure layer for swarms

Use these rules:

- Prefer keeping `IP` strict unless there is clear evidence that persistent single-IP abuse is being missed.
- Use `/24` tuning to increase local swarm sensitivity, but expect rule count to grow quickly.
- Use `/16` tuning to improve distributed swarm capture, but expect larger collateral impact.

### 3. Use near-miss data as the main tuning signal

Near-miss counts matter more than top offenders.

Interpret them like this:

- If many `/24` fail only by RPM, lower `--min-rpm-threshold` first.
- If many `/24` fail only by sustained, lower `--min-sustained-percent` first.
- If many `/24` fail only by swarm cardinality, lower `--ip-swarm-threshold`.
- If many `/16` fail only by IP count, lower `--supernet-min-ip-count`.
- If many `/16` fail only by total RPM, lower `--supernet-min-rpm-total`.
- If many IPs fail only by request count, consider lowering `--ip-min-requests` before lowering IP RPM.

If the dominant category is `mixed failures`, avoid recommending a strong change to only one parameter. Mixed failures usually mean the pattern is too diffuse for a single-threshold fix.

### 4. Compare sensitivity profiles by efficiency, not just coverage

When reading `Sensitivity Sweep`, compare:

- coverage increase
- rule growth
- which layers changed

Prefer a profile when:

- coverage improves meaningfully
- rule growth stays moderate
- the gain comes from the intended layer

Be skeptical of aggressive profiles when:

- rule count jumps sharply
- coverage increases only slightly
- the extra gain comes mostly from `/24` expansion

## Parameter Meaning

Use these parameter interpretations when recommending changes:

- `--min-rpm-threshold`: primary `/24` req/min gate. Lowering it increases subnet sensitivity fast.
- `--min-sustained-percent`: primary `/24` persistence gate. Lowering it makes shorter bursts count as sustained.
- `--ip-swarm-threshold`: `/24` IP-count gate for swarm-aware blocking. Lowering it favors smaller coordinated groups.
- `--ip-swarm-rpm-factor`: how much RPM is required for swarm-style `/24` blocks relative to effective RPM. Lowering it makes swarm blocking easier.
- `--ip-min-rpm-threshold`: per-IP req/min gate. Lowering it increases single-IP sensitivity.
- `--ip-min-sustained-percent`: per-IP persistence gate. Lowering it risks reacting to short-lived IP bursts.
- `--ip-min-requests`: per-IP total volume gate. Lowering it is often the fastest way to make IP blocking more aggressive.
- `--supernet-min-rpm-total`: `/16` total req/min gate.
- `--supernet-min-ip-count`: `/16` aggregated IP-count gate.
- `--supernet-min-requests`: `/16` total request volume gate.

## Safety Rules

Apply these rules unless the report clearly justifies an exception:

1. Do not recommend changing more than two thresholds at once for production.
2. Do not recommend lowering `IP` thresholds first when the report already shows the IP layer is active.
3. Do not recommend aggressive `/24` changes when coverage gain is small relative to rule growth.
4. Check whether top offenders look like legitimate crawlers, CDNs, or known infrastructure before recommending lower thresholds.
5. If host load is already very high, remember the blocker is already using lowered effective thresholds.

## Legitimate Traffic Check

Before recommending more aggressive blocking, inspect the top `/24` and `/16` entries for likely legitimate sources.

Examples of patterns that may require whitelist review:

- well-known crawler networks
- search engine infra
- monitoring providers
- trusted CDNs
- internal or partner IP ranges

If likely legitimate traffic dominates the top offenders:

- recommend reviewing whitelist first
- avoid using those entries as justification for lower thresholds

## What Not To Do

Do not:

- recommend tuning based only on the top offender rows
- recommend lowering every threshold at once
- equate low coverage with failure without considering how distributed the traffic is
- ignore rule growth when proposing more aggressive `/24` settings
- recommend removing the IP persistence layer unless there is direct evidence it is causing false positives

## Recommended Output Format

When analyzing a report, respond in this order:

1. `Traffic Pattern`
2. `Main Constraints`
3. `Best Next Experiment`
4. `Risks / Caveats`
5. `Concrete Parameter Changes`
6. `Validation Step`

Keep the answer practical:

- identify the dominant pattern
- explain which layer should be tuned, if any
- propose one conservative experiment first
- explain why more aggressive options are not yet justified

## Recommended Answer Style

Use short, direct statements.

Prefer:

- “The `/24` layer is constrained mostly by RPM.”
- “The IP layer is already active; do not lower IP thresholds first.”
- “The best next experiment is a small `/24` RPM reduction.”

Avoid:

- vague summaries
- generic security advice
- recommendations without naming the exact parameter

## Example Decision Logic

### Scenario A: `/24` fails mostly by RPM

Recommendation:

- lower `--min-rpm-threshold` slightly
- keep `--min-sustained-percent` unchanged
- keep IP thresholds unchanged

Why:

- the report indicates the primary bottleneck is RPM, so that is the cleanest lever

### Scenario B: `/16` fails mostly by IP count

Recommendation:

- lower `--supernet-min-ip-count` slightly
- keep `/24` thresholds unchanged

Why:

- this improves distributed swarm capture without broadening local subnet blocking as much

### Scenario C: aggressive profile doubles rules for little gain

Recommendation:

- reject the aggressive profile
- keep the balanced profile or make one smaller change

Why:

- the cost in collateral and operational load is not justified by the coverage increase

## Final Recommendation Constraint

If the report is based on a single snapshot:

- recommend an experiment, not a permanent “final” setting
- require validation with `blocker.py --dry-run`
- suggest generating another `tuning-snapshot.md` after the change

The correct mindset is iterative tuning, not one-shot optimization.
